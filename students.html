<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex">
    <meta name="description" content="Student Management System">
    <title>Student Management</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Additional styles for student management */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
        }
        
        /* Dialog styles */
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .dialog-box {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            width: 400px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .dialog-title {
            margin-top: 0;
            margin-bottom: 15px;
        }
        
        .dialog-content {
            margin-bottom: 20px;
        }
        
        .dialog-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .dialog-input {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .student-management-header {
            margin-bottom: 10px;
        }
        .filters-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .filter-box {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .instructor-filter, .group-filter {
            background-color: #ffff99; /* Light yellow */
        }
        
        .active-filter {
            background-color: #ffff99; /* Light yellow */
        }
        
        .reserved-container {
            background-color: #ffcc66; /* Light orange */
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 20px;
            min-height: 100px;
            text-align: center;
        }
        
        .search-container {
            text-align: right;
            margin-bottom: 10px;
        }
        
        table {
            width: 70%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        table, th, td {
            border: 1px solid #ddd;
        }
        
        th, td {
            padding: 8px;
            text-align: left;
        }
        
        th {
            background-color: #f2f2f2;
            cursor: pointer;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .checkbox-container {
            margin-bottom: 5px;
        }
        
        .radio-container {
            margin-bottom: 5px;
        }
        
        .side-containers {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .select-all {
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        /* Checkbox styling for row selection */
        .row-select {
            width: 20px;
            height: 20px;
        }
    </style>
</head>
<body>
    <header>
        <a href="index.html" class="logo">
            <img src="images/logo.png" alt="Logo" style="height: 40px;">
            <span>Home</span>
        </a>
        <nav>
            <a href="about.html">About</a>
            <a href="#">Our Services</a>
            <a href="contact.html">Let's Talk</a>
            <a href="instructor.html">Instructor Portal</a>
        </nav>
    </header>
    
    <div class="container">
        <div class="student-management-header">
            <h1>Student Management</h1>
            <div class="search-container">
                <input type="search" id="search-input" placeholder="Search students...">
            </div>
        </div>
        
        <div class="filters-container">
            <!-- Instructor Filter -->
            <div class="filter-box instructor-filter">
                <h3>Filter by instructor</h3>
                <div class="checkbox-container select-all">
                    <input type="checkbox" id="select-all-instructors" class="instructor-checkbox">
                    <label for="select-all-instructors">Select all</label>
                </div>
                <div id="instructor-checkboxes">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
            
            <!-- Group Filter -->
            <div class="filter-box group-filter">
                <h3>Filter by Group</h3>
                <div class="checkbox-container select-all">
                    <input type="checkbox" id="select-all-groups" class="group-checkbox">
                    <label for="select-all-groups">Select all</label>
                </div>
                <div id="group-checkboxes">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
            
            <!-- Dossier Records Container -->
            <div class="reserved-container">
                <h3>Student Dossier Records</h3>
                <div class="table-container">
                    <table id="dossier-table">
                        <thead>
                            <tr>
                                <th data-sort="timestamp" class="timestamp-column">Timestamp</th>
                                <th data-sort="studentName">Student Name</th>
                                <th data-sort="record">Record</th>
                            </tr>
                        </thead>
                        <tbody id="dossier-table-body">
                            <!-- Dossier data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Active Filter (Radio Buttons) -->
        <div class="filter-box active-filter">
            <h3>Active students</h3>
            <div class="radio-container">
                <input type="radio" id="all-students" name="active-filter" value="all" checked>
                <label for="all-students">All</label>
                
                <input type="radio" id="active-only" name="active-filter" value="active">
                <label for="active-only">Active only</label>
                
                <button id="create-comment-btn" disabled>Create comment</button>
            </div>
        </div>
        
        <div class="main-content">
            <!-- Students Table -->
            <div class="table-container">
                <table id="students-table">
                    <thead>
                        <tr>
                            <th style="width: 30px;"><input type="checkbox" id="select-all-rows"></th>
                            <th data-sort="name">Name</th>
                            <th data-sort="group">Group</th>
                            <th data-sort="instructor">Instructor</th>
                            <th data-sort="birthday">Birthday</th>
                            <th data-sort="startDate">Start Date</th>
                            <th style="width: 40px;" title="Has dossier records">Comment</th>
                        </tr>
                    </thead>
                    <tbody id="students-table-body">
                        <!-- Student data will be populated here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Side Containers for Stage 2 -->
            <div class="side-containers">
                <div class="reserved-container">
                    <h3>Reserved container 2 for new functions (Stage 2)</h3>
                </div>
                
                <div class="reserved-container">
                    <h3>Reserved container 3 for new functions (Stage 2)</h3>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Dialog for adding comments -->
    <div class="dialog-overlay" id="comment-dialog">
        <div class="dialog-box">
            <h3 class="dialog-title">Add a comment</h3>
            <div class="dialog-content">
                <textarea class="dialog-input" id="comment-input" placeholder="Add a comment"></textarea>
            </div>
            <div class="dialog-buttons">
                <button id="cancel-comment-btn">Cancel</button>
                <button id="save-comment-btn" disabled>Save</button>
            </div>
        </div>
    </div>
    
    <script src="config.js"></script>
    <script>
        // Global variables
        let students = [];
        let instructors = [];
        let groups = [];
        let dossiers = [];
        let currentSort = { field: 'name', direction: 'asc' };
        let dossierSort = { field: 'timestamp', direction: 'desc' };
        let selectedRows = [];
        let visibleStudents = []; // Store currently visible students after filtering
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', () => {
            // Fetch students data
            fetchStudents();
            
            // Fetch dossier data
            fetchDossiers();
            
            // Initialize event listeners
            initEventListeners();
        });
        
        // Initialize event listeners
        function initEventListeners() {
            // Search functionality
            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('input', filterStudents);
            
            // Comment button functionality
            const createCommentBtn = document.getElementById('create-comment-btn');
            createCommentBtn.addEventListener('click', openCommentDialog);
            
            // Comment dialog buttons
            const cancelCommentBtn = document.getElementById('cancel-comment-btn');
            cancelCommentBtn.addEventListener('click', closeCommentDialog);
            
            const saveCommentBtn = document.getElementById('save-comment-btn');
            saveCommentBtn.addEventListener('click', saveComment);
            
            // Comment input validation
            const commentInput = document.getElementById('comment-input');
            commentInput.addEventListener('input', validateCommentInput);
            
            // Student table sorting
            const studentTableHeaders = document.querySelectorAll('#students-table th[data-sort]');
            studentTableHeaders.forEach(header => {
                header.addEventListener('click', () => {
                    const field = header.getAttribute('data-sort');
                    sortStudents(field);
                });
            });
            
            // Dossier table sorting
            const dossierTableHeaders = document.querySelectorAll('#dossier-table th[data-sort]');
            dossierTableHeaders.forEach(header => {
                header.addEventListener('click', () => {
                    const field = header.getAttribute('data-sort');
                    sortDossiers(field);
                });
            });
            
            // Select all rows checkbox
            const selectAllRows = document.getElementById('select-all-rows');
            selectAllRows.addEventListener('change', () => {
                const checkboxes = document.querySelectorAll('.row-select');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = selectAllRows.checked;
                });
                updateSelectedRows();
            });
            
            // Active filter radio buttons
            const activeFilterRadios = document.querySelectorAll('input[name="active-filter"]');
            activeFilterRadios.forEach(radio => {
                radio.addEventListener('change', filterStudentsByActive);
            });
            
            // Select all instructors checkbox
            const selectAllInstructors = document.getElementById('select-all-instructors');
            selectAllInstructors.addEventListener('change', () => {
                const checkboxes = document.querySelectorAll('.instructor-checkbox:not(#select-all-instructors)');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = selectAllInstructors.checked;
                });
                filterStudentsByInstructor();
            });
            
            // Select all groups checkbox
            const selectAllGroups = document.getElementById('select-all-groups');
            selectAllGroups.addEventListener('change', () => {
                const checkboxes = document.querySelectorAll('.group-checkbox:not(#select-all-groups)');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = selectAllGroups.checked;
                });
                filterStudentsByGroup();
            });
        }
        
        // Fetch students data from Airtable
        async function fetchStudents() {
            try {
                console.log('GET operation - Sending request...');
                const airtableApiUrl = `https://api.airtable.com/v0/${config.airtable.baseId}/${config.airtable.tables.students}`;
                
                const response = await fetch(airtableApiUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${config.airtable.apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Airtable API error: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('GET operation - Response data:', data);
                
                // Format Airtable records to student objects
                students = data.records.map(record => ({
                    id: record.id,
                    name: record.fields.Name || '',
                    group: record.fields.Group || '',
                    instructor: record.fields.Instructor || '',
                    birthday: record.fields.Birthday || '',
                    startDate: record.fields["Start Date"] || '',
                    active: record.fields.Active === true
                }));
                
                // Initialize visibleStudents with all students
                visibleStudents = [...students];
                
                // Extract unique instructors and groups
                extractUniqueValues();
                
                // Populate filter checkboxes
                populateFilterCheckboxes();
                
                // Display students
                displayStudents();
            } catch (error) {
                console.error('Error fetching students:', error);
                // Show error message
            }
        }
        
        // Extract unique instructors and groups from students data
        function extractUniqueValues() {
            instructors = [...new Set(students.map(student => student.instructor))].filter(Boolean).sort();
            groups = [...new Set(students.map(student => student.group))].filter(Boolean).sort();
        }
        
        // Populate filter checkboxes
        function populateFilterCheckboxes() {
            // Populate instructor checkboxes
            const instructorCheckboxes = document.getElementById('instructor-checkboxes');
            instructorCheckboxes.innerHTML = '';
            
            instructors.forEach(instructor => {
                const checkboxContainer = document.createElement('div');
                checkboxContainer.className = 'checkbox-container';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `instructor-${instructor.replace(/\s+/g, '-')}`;
                checkbox.className = 'instructor-checkbox';
                checkbox.value = instructor;
                checkbox.checked = true;
                checkbox.addEventListener('change', () => {
                    // Update "Select all" checkbox
                    const allChecked = document.querySelectorAll('.instructor-checkbox:not(#select-all-instructors):checked').length === instructors.length;
                    document.getElementById('select-all-instructors').checked = allChecked;
                    
                    filterStudentsByInstructor();
                });
                
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = instructor;
                
                checkboxContainer.appendChild(checkbox);
                checkboxContainer.appendChild(label);
                instructorCheckboxes.appendChild(checkboxContainer);
            });
            
            // Populate group checkboxes
            const groupCheckboxes = document.getElementById('group-checkboxes');
            groupCheckboxes.innerHTML = '';
            
            groups.forEach(group => {
                const checkboxContainer = document.createElement('div');
                checkboxContainer.className = 'checkbox-container';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `group-${group.replace(/\s+/g, '-')}`;
                checkbox.className = 'group-checkbox';
                checkbox.value = group;
                checkbox.checked = true;
                checkbox.addEventListener('change', () => {
                    // Update "Select all" checkbox
                    const allChecked = document.querySelectorAll('.group-checkbox:not(#select-all-groups):checked').length === groups.length;
                    document.getElementById('select-all-groups').checked = allChecked;
                    
                    filterStudentsByGroup();
                });
                
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = group;
                
                checkboxContainer.appendChild(checkbox);
                checkboxContainer.appendChild(label);
                groupCheckboxes.appendChild(checkboxContainer);
            });
        }
        
        // Display students in the table
        function displayStudents(filteredStudents = null) {
            const studentsToDisplay = filteredStudents || students;
            
            // Clear table
            const studentsTableBody = document.getElementById('students-table-body');
            studentsTableBody.innerHTML = '';
            
            // Add students to table
            studentsToDisplay.forEach(student => {
                const row = document.createElement('tr');
                
                // Format dates for display
                const formattedBirthday = new Date(student.birthday).toLocaleDateString();
                const formattedStartDate = new Date(student.startDate).toLocaleDateString();
                
                // Check if student has dossier records
                const hasDossierRecords = dossiers.some(dossier => dossier.studentID === student.id);
                const dossierIcon = hasDossierRecords ? '&#128488;' : '';
                
                row.innerHTML = `
                    <td><input type="checkbox" class="row-select" data-id="${student.id}"></td>
                    <td>${student.name}</td>
                    <td>${student.group}</td>
                    <td>${student.instructor}</td>
                    <td>${formattedBirthday}</td>
                    <td>${formattedStartDate}</td>
                    <td style="text-align: center; font-size: 1.2em;" title="${hasDossierRecords ? 'Has dossier records' : 'No dossier records'}">${dossierIcon}</td>
                `;
                
                studentsTableBody.appendChild(row);
            });
            
            // Add event listeners to row checkboxes
            document.querySelectorAll('.row-select').forEach(checkbox => {
                checkbox.addEventListener('change', updateSelectedRows);
            });
        }
        
        // Update selected rows array
        function updateSelectedRows() {
            selectedRows = [];
            document.querySelectorAll('.row-select:checked').forEach(checkbox => {
                selectedRows.push(checkbox.getAttribute('data-id'));
            });
            console.log('Selected rows:', selectedRows);
            
            // Update dossier records based on selected students
            filterDossiersBySelectedStudents();
            
            // Update create comment button state
            updateCreateCommentButtonState();
        }
        
        // Update create comment button state based on selection
        function updateCreateCommentButtonState() {
            const createCommentBtn = document.getElementById('create-comment-btn');
            createCommentBtn.disabled = selectedRows.length !== 1;
        }
        
        // Open comment dialog
        function openCommentDialog() {
            if (selectedRows.length !== 1) {
                return; // Only proceed if exactly one student is selected
            }
            
            // Clear previous input
            document.getElementById('comment-input').value = '';
            
            // Disable save button initially
            document.getElementById('save-comment-btn').disabled = true;
            
            // Show dialog
            document.getElementById('comment-dialog').style.display = 'flex';
        }
        
        // Close comment dialog
        function closeCommentDialog() {
            document.getElementById('comment-dialog').style.display = 'none';
        }
        
        // Validate comment input
        function validateCommentInput() {
            const commentInput = document.getElementById('comment-input');
            const saveCommentBtn = document.getElementById('save-comment-btn');
            
            // Enable save button only if input is not empty
            saveCommentBtn.disabled = commentInput.value.trim() === '';
        }
        
        // Save comment to Airtable
        async function saveComment() {
            if (selectedRows.length !== 1) {
                return; // Only proceed if exactly one student is selected
            }
            
            const studentId = selectedRows[0];
            const commentText = document.getElementById('comment-input').value.trim();
            
            if (commentText === '') {
                return; // Don't save empty comments
            }
            
            try {
                // Find student name for notification
                const student = students.find(s => s.id === studentId);
                const studentName = student ? student.name : 'Unknown';
                
                // Prepare record data
                const recordData = {
                    fields: {
                        Record: commentText,
                        studentID: studentId,
                        'Created By': 'Instructor 1',
                        Timestamp: new Date().toISOString()
                    }
                };
                
                // Send POST request to Airtable
                const airtableApiUrl = `https://api.airtable.com/v0/${config.airtable.baseId}/${config.airtable.tables.dossiers}`;
                
                const response = await fetch(airtableApiUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${config.airtable.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(recordData)
                });
                
                if (!response.ok) {
                    throw new Error(`Airtable API error: ${response.status} ${response.statusText}`);
                }
                
                // Close dialog
                closeCommentDialog();
                
                // Show notification
                alert(`The comment to the student ${studentName} added`);
                
                // Refresh dossier data
                fetchDossiers();
                
            } catch (error) {
                console.error('Error saving comment:', error);
                alert('Error saving comment. Please try again.');
            }
        }
        
        // Sort students by field
        function sortStudents(field) {
            // Toggle sort direction if same field is clicked
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.direction = 'asc';
            }
            
            // Sort students
            students.sort((a, b) => {
                let valueA = a[field];
                let valueB = b[field];
                
                // Handle special cases for sorting
                if (field === 'birthday' || field === 'startDate') {
                    valueA = new Date(valueA);
                    valueB = new Date(valueB);
                } else if (typeof valueA === 'string') {
                    valueA = valueA.toLowerCase();
                    valueB = valueB.toLowerCase();
                }
                
                // Compare values
                if (valueA < valueB) {
                    return currentSort.direction === 'asc' ? -1 : 1;
                }
                if (valueA > valueB) {
                    return currentSort.direction === 'asc' ? 1 : -1;
                }
                return 0;
            });
            
            // Apply all filters
            applyAllFilters();
            
            // Update table headers
            const tableHeaders = document.querySelectorAll('#students-table th[data-sort]');
            tableHeaders.forEach(header => {
                const headerField = header.getAttribute('data-sort');
                if (headerField === field) {
                    header.textContent = `${header.textContent.replace(' ▲', '').replace(' ▼', '')} ${currentSort.direction === 'asc' ? '▲' : '▼'}`;
                } else {
                    header.textContent = header.textContent.replace(' ▲', '').replace(' ▼', '');
                }
            });
        }
        
        // Filter students based on search input
        function filterStudents() {
            applyAllFilters();
            // Update dossier records based on filtered students
            filterDossiersByVisibleStudents();
        }
        
        // Filter students by active status
        function filterStudentsByActive() {
            applyAllFilters();
            // Update dossier records based on filtered students
            filterDossiersByVisibleStudents();
        }
        
        // Filter students by instructor
        function filterStudentsByInstructor() {
            applyAllFilters();
            // Update dossier records based on filtered students
            filterDossiersByVisibleStudents();
        }
        
        // Filter students by group
        function filterStudentsByGroup() {
            applyAllFilters();
            // Update dossier records based on filtered students
            filterDossiersByVisibleStudents();
        }
        
        // Apply all filters
        function applyAllFilters() {
            // Get search term
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            
            // Get active filter value
            const activeFilter = document.querySelector('input[name="active-filter"]:checked').value;
            
            // Get selected instructors
            const selectedInstructors = Array.from(document.querySelectorAll('.instructor-checkbox:not(#select-all-instructors):checked')).map(checkbox => checkbox.value);
            
            // Get selected groups
            const selectedGroups = Array.from(document.querySelectorAll('.group-checkbox:not(#select-all-groups):checked')).map(checkbox => checkbox.value);
            
            // Apply filters
            const filtered = students.filter(student => {
                // Search filter
                const matchesSearch = !searchTerm || 
                    student.name.toLowerCase().includes(searchTerm) ||
                    student.group.toLowerCase().includes(searchTerm) ||
                    student.instructor.toLowerCase().includes(searchTerm);
                
                // Active filter
                const matchesActive = activeFilter === 'all' || (activeFilter === 'active' && student.active === true);
                
                // Instructor filter
                const matchesInstructor = selectedInstructors.length === 0 || selectedInstructors.includes(student.instructor);
                
                // Group filter
                const matchesGroup = selectedGroups.length === 0 || selectedGroups.includes(student.group);
                
                return matchesSearch && matchesActive && matchesInstructor && matchesGroup;
            });
            
            // Store the filtered students for dossier filtering
            visibleStudents = filtered;
            
            // Display filtered students
            displayStudents(filtered);
        }
        
        // Fetch dossier data from Airtable
        async function fetchDossiers() {
            try {
                console.log('GET operation - Sending dossier request...');
                const airtableApiUrl = `https://api.airtable.com/v0/${config.airtable.baseId}/${config.airtable.tables.dossiers}`;
                
                const response = await fetch(airtableApiUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${config.airtable.apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Airtable API error: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('GET operation - Dossier response data:', data);
                
                // Format Airtable records to dossier objects
                dossiers = data.records.map(record => ({
                    id: record.id,
                    timestamp: record.fields.Timestamp || '',
                    studentID: record.fields.studentID || '',
                    createdBy: record.fields['Created By'] || '',
                    record: record.fields.Record || ''
                }));
                
                // Sort dossiers by timestamp descending by default
                sortDossiers('timestamp');
                
                // Display dossiers
                displayDossiers();
                
                // Update student table to show dossier indicators
                if (students.length > 0) {
                    displayStudents(visibleStudents.length > 0 ? visibleStudents : students);
                }
            } catch (error) {
                console.error('Error fetching dossiers:', error);
                // Show error message
            }
        }
        
        // Display dossiers in the table
        function displayDossiers(filteredDossiers = null) {
            const dossiersToDisplay = filteredDossiers || dossiers;
            
            // Clear table
            const dossierTableBody = document.getElementById('dossier-table-body');
            dossierTableBody.innerHTML = '';
            
            // Add dossiers to table
            dossiersToDisplay.forEach(dossier => {
                const row = document.createElement('tr');
                
                // Find student name based on studentID
                const student = students.find(s => s.id === dossier.studentID);
                const studentName = student ? student.name : 'Unknown';
                
                // Format timestamp for display
                const formattedTimestamp = dossier.timestamp ? new Date(dossier.timestamp).toLocaleString() : '';
                
                row.innerHTML = `
                    <td>${formattedTimestamp}</td>
                    <td>${studentName}</td>
                    <td>${dossier.record}</td>
                `;
                
                dossierTableBody.appendChild(row);
            });
        }
        
        // Sort dossiers by field
        function sortDossiers(field) {
            // Toggle sort direction if same field is clicked
            if (dossierSort.field === field) {
                dossierSort.direction = dossierSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                dossierSort.field = field;
                // Default to descending for timestamp
                dossierSort.direction = field === 'timestamp' ? 'desc' : 'asc';
            }
            
            // Sort dossiers
            dossiers.sort((a, b) => {
                let valueA, valueB;
                
                // Special case for studentName (need to look up in students array)
                if (field === 'studentName') {
                    const studentA = students.find(s => s.id === a.studentID);
                    const studentB = students.find(s => s.id === b.studentID);
                    valueA = studentA ? studentA.name.toLowerCase() : '';
                    valueB = studentB ? studentB.name.toLowerCase() : '';
                } else {
                    valueA = a[field];
                    valueB = b[field];
                    
                    // Handle special cases for sorting
                    if (field === 'timestamp') {
                        valueA = new Date(valueA);
                        valueB = new Date(valueB);
                    } else if (typeof valueA === 'string') {
                        valueA = valueA.toLowerCase();
                        valueB = valueB.toLowerCase();
                    }
                }
                
                // Compare values
                if (valueA < valueB) {
                    return dossierSort.direction === 'asc' ? -1 : 1;
                }
                if (valueA > valueB) {
                    return dossierSort.direction === 'asc' ? 1 : -1;
                }
                return 0;
            });
            
            // Apply filter based on selected or visible students
            if (selectedRows.length > 0) {
                filterDossiersBySelectedStudents();
            } else {
                filterDossiersByVisibleStudents();
            }
            
            // Update table headers
            const tableHeaders = document.querySelectorAll('#dossier-table th[data-sort]');
            tableHeaders.forEach(header => {
                const headerField = header.getAttribute('data-sort');
                if (headerField === field) {
                    header.textContent = `${header.textContent.replace(' ▲', '').replace(' ▼', '')} ${dossierSort.direction === 'asc' ? '▲' : '▼'}`;
                } else {
                    header.textContent = header.textContent.replace(' ▲', '').replace(' ▼', '');
                }
            });
        }
        
        // Filter dossiers by selected students
        function filterDossiersBySelectedStudents() {
            if (selectedRows.length === 0) {
                // If no students selected, filter by visible students based on other filters
                filterDossiersByVisibleStudents();
                return;
            }
            
            // Filter dossiers to only show those for selected students
            const filtered = dossiers.filter(dossier => 
                selectedRows.includes(dossier.studentID)
            );
            
            displayDossiers(filtered);
        }
        
        // Filter dossiers by visible students (after applying instructor/group filters)
        function filterDossiersByVisibleStudents() {
            // If there are selected rows, prioritize those
            if (selectedRows.length > 0) {
                filterDossiersBySelectedStudents();
                return;
            }
            
            // If all students are visible, show all dossiers
            if (visibleStudents.length === students.length) {
                displayDossiers();
                return;
            }
            
            // Get IDs of visible students
            const visibleStudentIds = visibleStudents.map(student => student.id);
            
            // Filter dossiers to only show those for visible students
            const filtered = dossiers.filter(dossier => 
                visibleStudentIds.includes(dossier.studentID)
            );
            
            displayDossiers(filtered);
        }
    </script>
</body>
</html>
